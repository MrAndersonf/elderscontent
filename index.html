<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
      integrity="sha512-1ycn6IcaQQ40/MKBW2W4Rhis/DbILU74C1vSrLJxCq57o941Ym01SwNsOMqvEBFlcgUa6xLiPY/NS5R+E6ztJQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="index.css" />
    <title>Plataforma Idosos</title>
  </head>

  <body>
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="home-tab"
          data-bs-toggle="tab"
          data-bs-target="#home"
          type="button"
          role="tab"
          aria-controls="home"
          aria-selected="true"
        >
          Vídeos <i class="fab fa-youtube" aria-hidden="false"></i>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="profile-tab"
          data-bs-toggle="tab"
          data-bs-target="#profile"
          type="button"
          role="tab"
          aria-controls="profile"
          aria-selected="false"
        >
          Profile
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="contact-tab"
          data-bs-toggle="tab"
          data-bs-target="#contact"
          type="button"
          role="tab"
          aria-controls="contact"
          aria-selected="false"
        >
          Contact
        </button>
      </li>
    </ul>
    <div class="tab-content" id="myTabContent">
      <div
        class="tab-pane fade show active"
        id="home"
        role="tabpanel"
        aria-labelledby="home-tab"
      >
        <div style="display: flex; flex-direction: row">
          <div class="main_content">
            <h2 style="font-weight: 600; color: #000">Cadastre novos vídeos</h2>
            <div class="input_section">
              <label class="text_label" for="id">Código do vídeo</label>
              <input id="id" class="input_label" type="text" />
            </div>
            <div class="input_section">
              <label class="text_label" for="video_id">Título do vídeo</label>
              <textarea
                id="title"
                class="input_title"
                rows="5"
                cols="60"
              ></textarea>
            </div>
            <div class="input_section">
              <label class="text_label" for="tag">Assuntos Relacionados</label>
              <div style="display: flex; flex-direction: row">
                <input id="tag" class="input_label" type="text" />
                <button
                  class="btn btn-success btn_cadastrar"
                  onclick="insertSubject(event)"
                  style="margin-left: 5px"
                >
                  Adicionar
                </button>
              </div>
            </div>
            <div class="subjects" id="subjects_container"></div>
            <div class="input_section">
              <button
                class="btn_cadastrar"
                onclick="writeVideoToFirebase(event)"
              >
                Cadastrar
              </button>
            </div>
          </div>
          <div class="second_content">
            <div id="videos_list" style="overflow: auto"></div>
          </div>
        </div>
      </div>

      <div
        class="tab-pane fade"
        id="profile"
        role="tabpanel"
        aria-labelledby="profile-tab"
      >
        <div style="display: flex; flex-direction: row">
          <div class="main_content_recepi">
            <h2 style="font-weight: 600; color: #000">Cadastre Receitas</h2>
            <div
              style="
                display: flex;
                flex-direction: row;
                width: 80%;
                justify-content: space-between;
              "
            >
              <div class="input_section_half">
                <label class="text_label" for="recepi_id"
                  >Código do vídeo</label
                >
                <input
                  id="recepi_id"
                  class="input_label"
                  type="text"
                  onblur="setThumbnail(this.value)"
                />
              </div>
              <div class="input_section_half">
                <label class="text_label" for="recepi_name"
                  >Nome do Prato</label
                >
                <input
                  type="text"
                  id="recepi_name"
                  class="input_label"
                  onblur="setRecipeName(this.value)"
                />
              </div>
            </div>
            <div class="input_section">
              <button class="btn btn-success">Criar Receita</button>
            </div>

            <div class="input_section">
              <label class="text_label" for="recepi_section"
                >Nome da Categoria</label
              >
              <input type="text" id="recepi_section" class="input_label" />
            </div>
            <div class="input_section">
              <label class="text_label" for="tag">Adicionar linha</label>
              <div style="display: flex; flex-direction: row">
                <input id="recepi_row" class="input_label" type="text" />
                <button
                  class="btn btn-success btn_cadastrar"
                  onclick="insertRecepiRow(event)"
                  style="margin-left: 5px"
                >
                  Adicionar
                </button>
              </div>
            </div>
            <div class="subjects" id="rows_container"></div>
            <div class="recepi_buttons_section">
              <button
                class="btn_cadastrar"
                onclick="writeVideoToFirebase(event)"
              >
                Próxima Categoria
              </button>
              <button
                class="btn_cadastrar"
                onclick="writeVideoToFirebase(event)"
              >
                Cadastrar
              </button>
            </div>
          </div>
          <div class="recipe_preview">
            <div id="videos_list" style="overflow: auto">
              <div style="width: 100%">
                <img
                  id="recepi_video"
                  style="width: 100%; height: fit-content"
                  alt=""
                />
              </div>

              <div class="recepi_preview_title">
                <h3 id="preview_title"></h3>
              </div>

              <div class="recepi_preview_category">
                <h4>kjhdshfksdhfkshdfhsd</h4>
                <div class="preview_category_list">
                  <h5>kjhdshfksdhfkshdfhsd</h5>
                  <h5>kjhdshfksdhfkshdfhsd</h5>
                  <h5>kjhdshfksdhfkshdfhsd</h5>
                  <h5>kjhdshfksdhfkshdfhsd</h5>
                  <h5>kjhdshfksdhfkshdfhsd</h5>
                </div>
              </div>

              <div class="recepi_preview_category">
                <h4>kjhdshfksdhfkshdfhsd</h4>
                <div class="preview_category_list">
                  <h5>kjhdshfksdhfkshdfhsd</h5>
                  <h5>kjhdshfksdhfkshdfhsd</h5>
                  <h5>kjhdshfksdhfkshdfhsd</h5>
                  <h5>kjhdshfksdhfkshdfhsd</h5>
                  <h5>kjhdshfksdhfkshdfhsd</h5>
                </div>
              </div>

              <div style="display: flex; justify-content: center">
                <h4>kjhdshfksdhfkshdfhsd</h4>
              </div>
              <div style="display: flex; justify-content: center">
                <h4>kjhdshfksdhfkshdfhsd</h4>
              </div>
              <div style="display: flex; justify-content: center">
                <h4>kjhdshfksdhfkshdfhsd</h4>
              </div>
              <div style="display: flex; justify-content: center">
                <h4>kjhdshfksdhfkshdfhsd</h4>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div
        class="tab-pane fade"
        id="contact"
        role="tabpanel"
        aria-labelledby="contact-tab"
      >
        ...
      </div>
    </div>

    <div
      class="modal fade"
      id="modalEdit"
      tabindex="-1"
      role="dialog"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div
          class="modal-content"
          style="
            background-color: #4158d0;
            background-image: linear-gradient(
              43deg,
              #4158d0 0%,
              #c850c0 46%,
              #ffcc70 100%
            );
          "
        >
          <div class="modal-header">
            <h5
              class="modal-title"
              id="exampleModalLabel"
              style="color: #fff; font-weight: 900"
            >
              Editar registro
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span style="color: #fff; font-weight: 900" aria-hidden="true"
                >&times;</span
              >
            </button>
          </div>
          <div class="modal-body">
            <div class="input_section">
              <div class="section_label">
                <label class="text_label" for="video_id">Código do vídeo</label>
              </div>
              <input id="idEdit" class="input_label" type="text" />
            </div>
            <div class="input_section">
              <div class="section_label">
                <label class="text_label" for="video_id">Título do vídeo</label>
              </div>
              <input id="titleEdit" class="input_label" type="text" />
            </div>
            <div class="input_section">
              <div class="section_label">
                <label class="text_label" for="video_id">Assunto (TAGS)</label>
              </div>
              <input id="tagEdit" class="input_label" type="text" />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-danger"
              data-dismiss="modal"
              style="width: 100px; font-weight: 900"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-primary"
              style="width: 100px; font-weight: 900"
              onclick="event.preventDefault();editVideoFromFirebase()"
            >
              Salvar
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="modalPlay"
      tabindex="-1"
      role="dialog"
      aria-labelledby="exampleModalCenterTitle"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content modal-md">
          <iframe
            id="videoSource"
            width="540"
            height="360"
            frameborder="0"
            allowfullscreen
          ></iframe>
        </div>
      </div>
    </div>

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
      <div
        id="liveToast"
        class="toast hide"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="toast-header" style="background-color: #4158d0">
          <strong class="me-auto" style="color: white">App Viver</strong>
          <small id="toast_time" style="color: white"></small>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
        <div
          class="toast-body"
          id="toast_message"
          style="background-color: rgb(121, 37, 200); color: white"
        ></div>
      </div>
    </div>

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
      <div
        id="confirmDelete"
        class="toast hide"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="toast-body gradient">
          <span
            id="confirm_message"
            style="color: white; font-weight: 600; font-size: 18px"
          ></span>
          <div class="mt-2 pt-2 border-top">
            <button
              id="buttonDeleteVideo"
              type="button"
              class="btn btn-danger w-100 mb-1"
            >
              Confirmar
            </button>
            <button
              type="button"
              class="btn btn-warning w-100"
              data-bs-dismiss="toast"
            >
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-analytics.js"></script>

    <script>
      let recipeIngredients = [];
      let listOfIngredients = [];
      let subjectsList = [];
      let recipe_obj = new Object();
      let section = new Object();
      let rows = [];

      var firebaseConfig = {
        apiKey: "AIzaSyCKDICRkVxUdBBtrlENCC_X3oOTed92UTw",
        authDomain: "myappproject-5852a.firebaseapp.com",
        projectId: "myappproject-5852a",
        storageBucket: "myappproject-5852a.appspot.com",
        messagingSenderId: "994101301871",
        appId: "1:994101301871:web:93554248936885f709b39a",
        measurementId: "G-X968L09L5K",
      };

      firebase.initializeApp(firebaseConfig);

      firebase.analytics();

      var firestore = firebase.firestore();

      readVideoFromFirebase();

      confirmDeleteNotify("dsds");

      function hasInvalidInputs(inputs) {
        let invalids = 0;
        inputs.forEach((input) => {
          if (input === "") {
            invalids += 1;
            console.log(invalids);
          }
        });
        if (invalids > 0) {
          notify("Existem campos obrigatórios não preenchidos.");
          return true;
        }
        return false;
      }
      function writeVideoToFirebase(e) {
        e.preventDefault();
        let _id = getElement("id");
        let _title = getElement("title");
        let inputs = [_id.value, _title.value];
        if (hasInvalidInputs(inputs)) return;
        if (isEmpty(subjectsList)) return;
        let path = `Videos/${_id.value}`;
        const docref = firestore.doc(path);
        docref
          .set({
            id: _id.value,
            title: _title.value,
            tags: [...subjectsList],
            likes: [],
            comments: [],
          })
          .then(() => {
            readVideoFromFirebase();
            _id.value = "";
            _title.value = "";
            subjectsList = [];
            cleanChildren("subjects_container");
            notify("Registro salvo com sucesso!");
          })
          .catch((err) => console.log(err));
      }
      function writeRecipeToFirebase(e) {
        e.preventDefault();
        let _id = getElement("recepi_id");
        let _name = getElement("recepi_name");
        let inputs = [_id.value, _name.value];
        if (hasInvalidInputs(inputs)) return;
        if (isEmpty(subjectsList)) return;
        let path = `Videos/${_id.value}`;
        const docref = firestore.doc(path);
        docref
          .set({
            id: _id.value,
            name: _name.value,
          })
          .then(() => {
            readVideoFromFirebase();
            _id.value = "";
            _name.value = "";
            cleanChildren("subjects_container");
            notify("Registro salvo com sucesso!");
          })
          .catch((err) => console.log(err));
      }
      function editVideoFromFirebase() {
        let _id = $("#idEdit").val();
        let _title = $("#titleEdit").val();
        let _tag = $("#tagEdit").val();
        if (_id && _title && _tag !== "") {
          const docref = firestore.doc(`Videos/${_id}`);
          docref
            .set({
              id: _id,
              title: _title,
              tags: [..._tag.split(",")],
            })
            .then(() => {
              readVideoFromFirebase();
              $("#idEdit").val("");
              $("#titleEdit").val("");
              $("#tagEdit").val("");
              $("#modalEdit").modal("hide");
              alert("Registro editado com sucesso!");
            })
            .catch((err) => console.log(err));
        }
      }
      function deleteRegister(e, id) {
        e.preventDefault();
        let buttonDel = getElement("buttonDeleteVideo");
        confirmDeleteNotify("Confirma a exclusão do vídeo ?");
        buttonDel.onclick = function () {
          deleteVideoFromFirebase(id);
        };
      }
      function deleteVideoFromFirebase(id) {
        firestore
          .collection("Videos")
          .doc(id)
          .delete()
          .then(() => {
            readVideoFromFirebase();
            closeToastNotificationDelete();
            notify("Registro deletado com sucesso.");
          })
          .catch((error) => {
            console.error("Error removing document: ", error);
          });
      }

      var myModal = new bootstrap.Modal(document.getElementById("modalPlay"), {
        keyboard: false,
      });

      let videoModal = document.getElementById("modalPlay");

      videoModal.addEventListener("hidden.bs.modal", () => {
        let iframeVideo = getElement("videoSource");
        iframeVideo.src = "";
      });
      function playVideo(id) {
        let videoSource = `https://www.youtube.com/embed/${id}?&autoplay=1`;
        let iframeVideo = getElement("videoSource");
        iframeVideo.src = videoSource;
        myModal.show();
      }
      function playEdit(id) {
        firestore
          .collection("Videos")
          .doc(id)
          .get()
          .then((querySnapshot) => {
            let doc = querySnapshot.data();
            getElement("id").value = doc.id;
            getElement("title").value = doc.title;
            subjectsList = doc.tags;
            let pills = doc.tags.map((sub) => createSubjectPill(sub));
            pills.forEach((pill) => addPillToSubjectList(pill));
          });
      }
      function readVideoFromFirebase() {
        let videos = [];
        firestore
          .collection("Videos")
          .get()
          .then((querySnapshot) => {
            querySnapshot.docs.forEach((doc) => {
              videos.push(` <div style="display: flex; flex-direction: row">
          <div style="width: 100%">
            <img
              style="width:100%;height:fit-content "
              src="https://img.youtube.com/vi/${doc.data().id}/0.jpg"
              alt=""
            />
            <div class="video_details">
              <div class="details">
                <div class="itens">Vídeo</div>
                <div class="description">${doc.data().id}</div>
              </div>
              <div class="details">
                <div class="itens">Título:</div>
                <div class="description">${doc.data().title}</div>
              </div>
              <div class="details">
                <div class="itens">Tags:</div>
                <div class="description">${doc.data().tags.join(",")}</div>
              </div>
            </div>
          </div>
          <div
            style="
              
              display: flex;
              flex-direction: column;
              position:relative;
              top:2px;
              left:-41px;
            "
          >
            <div class="btn_video_area">
              <button
              class="btn_video"
                onclick="deleteRegister(event,'${doc.data().id}')"
              >
                <img src="./trash-2.svg" alt="" />
              </button>
            </div>
            <div class="btn_video_area">
              <button
             class="btn_video"
                onclick="playEdit('${doc.data().id}')"
              >
                <img src="./edit.svg" alt="" />
              </button>
            </div>
            <div class="btn_video_area">
              <button
               class="btn_video"
                onclick="playVideo('${doc.data().id}')"
              >
                <img src="./youtube.svg" alt="" />
              </button>
            </div>
          </div>
        </div>`);
            });
            insertToPage(videos);
          });
      }
      function cleanChildren(id) {
        let element = document.getElementById(id);
        if (element.childElementCount == 0) return element;
        element.innerHTML = "";
        return element;
      }
      function appendHTML(element, content) {
        element.innerHTML = content;
      }
      function insertToPage(content) {
        let element = cleanChildren("videos_list");
        appendHTML(element, content);
      }
      function setMessageToModalNotify(message) {
        document.getElementById("toast_message").innerText = message;
      }
      function setMessageToModalConfirmDelete(message) {
        document.getElementById("confirm_message").innerText = message;
      }
      function convertToDateTimePtBr(date) {
        let day = date.toLocaleDateString("pt-br");
        let time = date.toLocaleTimeString("pt-br");
        return `${day} - ${time}`;
      }
      function setDateTimeToModalNotify() {
        document.getElementById("toast_time").innerText = convertToDateTimePtBr(
          new Date()
        );
      }
      function toastNotification() {
        let option = {
          animation: true,
          autohide: true,
          delay: 3000,
        };
        let toast = document.getElementById("liveToast");
        let alerter = new bootstrap.Toast(toast, option);
        alerter.show();
      }
      function toastNotificationDelete() {
        let option = {
          animation: true,
          autohide: true,
          delay: 5000,
        };
        let toast = document.getElementById("confirmDelete");
        let alerter = new bootstrap.Toast(toast, option);
        alerter.show();
      }
      function closeToastNotificationDelete() {
        let toast = document.getElementById("confirmDelete");
        let alerter = new bootstrap.Toast(toast);
        alerter.hide();
      }
      function notify(message) {
        setMessageToModalNotify(message);
        setDateTimeToModalNotify();
        toastNotification();
      }
      function confirmDeleteNotify(message) {
        setMessageToModalConfirmDelete(message);
        toastNotificationDelete();
      }
      function getElement(id) {
        try {
          let element = document.getElementById(id);
          if (!element) {
            console.log(
              `Error: id ${id} doesn't references any HTML valid object.`
            );
            return;
          }
          return element;
        } catch (error) {
          console.log(error);
        }
      }
      function createElement(tagName) {
        return document.createElement(tagName);
      }
      function setElementCssClass(element, className) {
        element.classList.add(className);
      }
      function setElementInnerText(element, text) {
        element.innerText = text;
      }
      function setElementInnerHTML(element, innerHTML) {
        element.innerHTML = innerHTML;
      }
      function appendChild(element, child) {
        element.appendChild(child);
      }
      function handleSubjectsList(newSubject) {
        return (subjectsList = [...subjectsList, newSubject]);
      }
      function handleRowsList(row) {
        rows = [...rows, row];
      }
      function createSubjectPill(value) {
        let mainDiv = createElement("div");
        setElementCssClass(mainDiv, "subjects_item");
        let divValue = createElement("div");
        divValue.appendChild(document.createTextNode(value));
        let divBtn = createElement("div");
        setElementCssClass(divBtn, "subject_button");
        let button = createElement("button");
        button.onclick = function () {
          removePillFromSubjectList(event, value);
        };
        setElementCssClass(button, "remove_subject");
        setElementInnerHTML(button, '<i class="fas fa-trash-alt"></i>');
        appendChild(divBtn, button);
        appendChild(mainDiv, divValue);
        appendChild(mainDiv, divBtn);
        return mainDiv;
      }
      function addPillToSubjectList(pill) {
        let element = getElement("subjects_container");
        appendChild(element, pill);
      }
      function addPillToRowsList(pill) {
        let element = getElement("rows_container");
        appendChild(element, pill);
      }
      function removePillFromSubjectList(e, value) {
        e.preventDefault();
        cleanChildren("subjects_container");
        subjectsList.splice(subjectsList.indexOf(value), 1);
        let pills = subjectsList.map((sub) => createSubjectPill(sub));
        pills.forEach((pill) => addPillToSubjectList(pill));
      }
      function isEmpty(value) {
        if (value == "") {
          notify("O campo ASSUNTO não pode ser vazio.");
          return true;
        }
      }
      function isEmpty(value) {
        let type = typeof value;
        console.log(type);
        if (type === "string") {
          if (value == "") {
            notify("O campo ASSUNTO não pode ser vazio.");
            return true;
          }
        }
        if (type === "object") {
          if (value.length <= 0) {
            notify("O campo ASSUNTO não pode ser vazio.");
            getElement("tag").focus();
            return true;
          }
        }
      }
      function alreadyExists(value) {
        if (subjectsList.includes(value.toLowerCase())) {
          notify("O assunto já está selecionado.");
          return true;
        }
      }
      function insertSubject(e) {
        e.preventDefault();
        let subject = getElement("tag");
        if (isEmpty(subject.value)) return;
        if (alreadyExists(subject.value)) return;
        let pill = createSubjectPill(subject.value);
        handleSubjectsList(subject.value);
        addPillToSubjectList(pill);
        subject.value = "";
        subject.focus();
      }
      function insertRecepiRow(e) {
        e.preventDefault();
        let subject = getElement("recepi_row");
        if (isEmpty(subject.value)) return;
        if (alreadyExists(subject.value)) return;
        let pill = createSubjectPill(subject.value);
        handleRowsList(subject.value);
        addPillToRowsList(pill);
        subject.value = "";
        subject.focus();
      }
      function setThumbnail(id) {
        document.getElementById(
          "recepi_video"
        ).src = `https://img.youtube.com/vi/${id}/0.jpg`;
        recipe_obj.video_id = id;
      }
      function setRecipeName(name) {
        document.getElementById("preview_title").textContent = name;
        recipe_obj.recepi_name = name;
      }
      function setRecipeSection(section) {
        section.name = section;
      }
    </script>
  </body>
</html>
